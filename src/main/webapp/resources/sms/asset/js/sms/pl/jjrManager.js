define("sms/suggestView",function(){function e(e){return e.val().length}var t=$.BaseModel,a=Backbone.Model.extend(),n=Backbone.Collection.extend({model:a,parse:function(e){return e?e.data:[]}}),i=t.extend({initialize:function(){var e=this,t=this.get("collection");e.on("change",function(){t.url=$.joinURL(e.get("url"),e.get("args"));var a=e.get("args")[e.keyword]||"";if(e.isStatic&&e.collData){for(var n=[],i=0;i<e.collData.length;i++){var r=e.collData[i];r.name.indexOf(a)>=0&&n.push(r)}t.set(n),t.trigger("sync")}else t.fetch()})},setArgs:function(e){var t=this,a=_.clone(t.get("args"));$.extend(a,e),t.set("args",a),t.trigger("change")},saveDataList:function(e){var t=this;t.collData=e}}),r=Backbone.View.extend({template:_.template('<%for(var i =0;i<list.length;i++){%><li actVal="<%=list[i].value%>"><a href="javascript:;"><%=list[i].name%><%=list[i].value?("("+list[i].value+")"):""%></a></li><%}%>'),className:"ttt",initialize:function(){var e=this;this.listenTo(e.collection,"sync",function(){e.render()}),e.on("enter",function(t){e.$(".dropdown-menu").hide();var a=e.collection.at(t);a&&(e.$("[type='hidden']").val(a.get("value")),e.$("[type='text']").val(a.get("name"))),e.trigger("selectValue",a)}),$(document.body).on("click",function(){e.$(".dropdown-menu").hide()})},clearData:function(){var e=this;e.$("[type='hidden']").val(""),e.trigger("selectValue",!1)},render:function(){var e=this,t=e.$(".dropdown-menu"),a=e.collection.toJSON();a.length?(t.html(e.template({list:a})),t.show()):t.hide()},events:{"keyup input":"keyup","keydown input":"keydown","focus input":"setSearchValue","click input":"setSearchValue","click .actFocus":"focus","mouseenter li":"mouseenter","click li":"select"},focus:function(e){var t=this;$(e.currentTarget).blur();var a=this.$("input"),n={};return n[a.attr("name")]="",t.model.setArgs(n),!1},keydown:function(e){$.inArray(e.keyCode,[38,40,13])>=0&&(e.preventDefault(),e.stopPropagation())},keyup:function(e){var t=this;switch(e.keyCode){case 8:t.clearData(),t.setSearchValue();break;case 38:return t.pre(),e.preventDefault(),e.stopPropagation(),!1;case 40:return e.preventDefault(),e.stopPropagation(),t.next(),!1;case 13:return t.enter(),!1;default:t.setSearchValue()}return!1},scrollToCur:function(e){e=$(e);var t=e.parent(),a=e.get(0).offsetTop;a>t.height()+t.get(0).scrollTop&&(t.get(0).scrollTop=a-t.height()+2*e.height()),t.get(0).scrollTop>a&&(t.get(0).scrollTop=a-t.height())},pre:function(){var e=this,t=e.$("li");if(t.length){var a=e._getCurSelect(),n=-1;a>=0&&(n=a-1),t.removeClass("active"),t.eq(n).addClass("active"),e.scrollToCur(t.eq(n))}},next:function(){var e=this,t=e.$("li");if(t.length){var a=e._getCurSelect(),n=-1;n=a>=t.length-1?0:a+1,t.removeClass("active"),t.eq(n).addClass("active"),e.scrollToCur(t.eq(n))}},enter:function(){var e=this,t=e._getCurSelect();e.trigger("enter",-1==t?0:t)},_getCurSelect:function(){for(var e=this,t=e.$("li"),a=0,n=t.length;n>a;a++)if(t.eq(a).hasClass("active"))return a;return-1},select:function(e){var t=e.currentTarget;this.$("li").removeClass("active"),$(t).addClass("active"),this.enter()},mouseenter:function(e){var t=e.currentTarget;this.$("li").removeClass("active"),$(t).addClass("active")},_searchTimeout:!1,setSearchValue:function(){var t=this;t._searchTimeout&&clearTimeout(t._searchTimeout),t._searchTimeout=setTimeout(function(){var a=t.$("input"),n=e(a),i=a.val().substring(0,n),r={};r[a.attr("name")]=i,t.model.setArgs(r)},300)},initSearchData:function(e){var t=this,a=t.$("input");e=e||{},e[a.attr("name")]="";var n=t.model;n.keyword=a.attr("name"),$.ajax({url:$.joinURL(n.get("url"),e)}).success(function(e){var a=t.collection.parse(e);a&&a.length&&t.model.saveDataList(a)})}});return function(e){var t={url:"",args:{},el:"",parse:!1};$.extend(t,e);var a=new n({});t.parse&&(a.parse=t.parse);var l=new i({collection:a,args:t.args,url:t.url}),o=new r({collection:a,model:l,el:t.el});return t.isStatic&&(l.isStatic=!0,o.initSearchData(t.args)),o}}),define("sms/pl/jjrManager",function(require){var e=Backbone.Collection.extend({model:Backbone.Model.extend({idAttribute:"uCode"}),initialize:function(e,t){var a=this,n={args:{},url:""};_.extend(n,t),a.option=n},setArgs:function(e){var t=this;_.extend(t.option.args,e),t.fetch()},url:function(){return $.joinURL(this.option.url,this.option.args)},parse:function(e){return this.data=e,e.content}}),t=require("sms/suggestView"),a=Backbone.View.extend({initialize:function(){var e=this;e.listenTo(e.model,"dataload",function(){e.render()}),e.template=_.template($("#updateUserRelateTemplate").html()),e.$el.hide(),e.suggestView=t({el:e.$el,url:$.config.api.jingjirensearch,args:{},parse:function(e){var t=[];return e.data&&_.each(e.data,function(e){t.push({name:e.uName,value:e.uCode})}),t}})},events:{"click .close":"hide","click .actSave":"submit"},hide:function(){var e=this;e.layer&&e.layer.destroy(),e.layer=null,this.$el.hide()},render:function(){var e=this;e.$el.html(e.template(e.model.toJSON())),e.$el.show()},submit:function(e){function t(){i.removeClass("disabled"),i.html(i.hasClass("actDel")?"删除":"保存")}function a(e){n.layer&&(n.layer.destroy(),n.layer=null),n.layer=alertPop(n.$("input"),e||"操作失败"),$(n.$("input")).focus(function(){n.layer.destroy()})}var n=this,i=$(e.target);if(!i.hasClass("disabled")){var r={uCode:n.model.get("uCode"),uMasterName:n.$("#inputRelate").val(),masterCode:n.$("#inputRelateHide").val(),uMasterCode:n.$("#inputRelateHide").val()};if(!n.$("#inputRelate").val())return void a("师傅不能为空");i.addClass("disabled"),i.html("提交中..");var l=1,o=$.config.api.jingjirenbuild,s=n.model.toJSON();n.$("input").val()?s.uMasterCode&&(o=$.config.api.jingjirenupdate,l=2):(o=$.config.api.jingjirendelete,l=3),$.ajax(o,{type:"post",data:r}).complete(function(e){if(t(),e.responseText)if(e=e.responseJSON,"1"==e.code){e.data=e.data||{buildDate:(new Date).getTime()},1==l?r.buildDate=e.data.buildDate:2==l?r.buildDate=e.data.buildDate:3==l&&(r.buildDate=!1),alert("设置成功"),n.hide();try{n.model.set(r)}catch(i){}n.model.trigger("datachange")}else a(e&&(e.reason||e.msg));else a(e&&(e.reason||e.msg))}).fail(function(e){t(),a(e&&(e.reason||e.msg))})}}}),n=Backbone.View.extend({tagName:"tr",template:_.template($("#personManagerTemplate").html()),initialize:function(t,n){var i=this;i.collection=new e({},n),i.listenTo(i.collection,"sync",function(){i.render()}),i.listenTo(i.collection,"change",function(){i.render()}),i.model=new Backbone.Model,i.editView=new a({model:i.model,el:"#updateUserRelate"}),i.listenTo(i.model,"datachange",function(){var e=i.collection.get(i.model.get("uCode"));e.set(i.model.toJSON())})},render:function(){this.collection.data.list=this.collection.toJSON(),this.$el.html(this.template(this.collection.data))},init:function(){this.collection.fetch()},events:{"click .actEdit":"edit","click .pagination li":"showPage","click .actDel":"actDel"},actDel:function(e){var t=this,a=$(e.currentTarget),n=a.attr("actData"),i=$.queryToJson(n);if(confirm('是否确定删除"'+i.uName+'和""'+i.uMasterName+'"的师徒关系?\n删除将会影响到师傅的收益\n该师徒关系删除后，将无法重新匹配')){var r={uCode:i.uCode,uMasterName:i.uMasterName,masterCode:i.uMasterCode,uMasterCode:i.uMasterCode};$.ajax({url:$.config.api.jingjirendelete,type:"post",data:r}).success(function(e){if(e&&"1"==e.code){var a=t.collection.get(i.uCode);a.set({uMasterCode:"",uMasterName:"",buildDate:!1})}else alert(e&&e.reason?e.reason:"删除失败")})}},edit:function(e){var t=$(e.currentTarget),a=t.attr("actData"),n=$.queryToJson(a);this.model.set(n),this.model.trigger("dataload")},showPage:function(e){var t=$(e.currentTarget);if(t.hasClass("actPage")){var a=t.attr("page");this.collection.setArgs({page:a})}return $("html,body").animate({scrollTop:0},300),!1}});return n});