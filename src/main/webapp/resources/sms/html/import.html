<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>链家网-店面管理系统</title>
<meta charset="utf-8">
<link href="../asset/img/favicon.ico" type="image/x-icon" rel=icon><link href="../asset/img/favicon.ico" type="image/x-icon" rel="shortcut icon">
<link rel="stylesheet" type="text/css" href="../asset/css/common.css?v=1.72"">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="../dep/bootstrap/css/bootstrap.min.css?v=1.72"" rel="stylesheet" media="screen">

<!--[if lt IE 9]>
 <script type="text/javascript" src="../dep/support/html5.js?v=1.72""></script>
 <script src="../dep/support/respond.min.js?v=1.72""></script>
<![endif]-->
<script type="text/javascript" src="../dep/dep.js?v=1.72"></script>
<script src="../asset/js/common/common.js?v=1.72""></script>
  
  <link rel="stylesheet" type="text/css" href="../asset/css/index.css?v=1.72"">
  <style type="text/css">
.file-list ul{
  margin:0;
  width:400px;
  margin-bottom:30px;
}
.file-list li{
  list-style: none;
  overflow: hidden;
  margin:0;
  padding:5px 0;
}
.file-list li .close{
  float:left;
  margin-right: 10px;
}
.upload-area{
  width:400px;
  height: 300px;
  background:#fff;
  border:1px dashed #ededed;
  line-height: 300px;
  text-align: center;
  vertical-align: middle;
  position: relative;
  margin-top:10px;
}
.upload-area-min{
  height: 40px;
  border:0;
  line-height: 40px;
}
.upload-area-min form{
  height: 30px;
  position: relative;
}
.upload-area-min .up-info{
  display: none;
}
.little-upload-area{
  height: 40px;
}
.upload-area .btn{
  display: none;
}
.upload-area .input-append{
  position: absolute;

}
.upload-area input[type="text"]{
  display:none;
}
#searchFile{
  position: absolute;
  width:100%;
  height: 100%;
  z-index: 1;
  opacity: 0;
  left:0px;
  top:0px;
}
.msglist{
  display: none;
  position: absolute;
  width: 500px;
  height: 100%;
  left: 450px;
  top: 0px;
  border:1px solid #999;
  background-color:#DB97B6;
  overflow: auto;
}
.dow-example a{
  margin-right: 10px;

}
  </style>
  </head>
  <body>

<div class="max-wrapper">

  <header class="header">
  <div class="logo">
    <p class="sms">SMS<span class="sys-name">链家店面管理系统</span></p>
    <p class="sms-all">Store Management System</p>
  </div>
   <span class="sms-current-user" id="showUserName"></span>
   <script type="text/template" style="display:none" id="showUserNameTemplate">
    <%if(code ==1){%>
      你好，<%=data.userName%>
      <%if(!data.enterSystemDirectly){%>
        <a href="<%=config.changeStore%>">切换店面</a>
      <%}%>
      <a href="<%=config.logoutUrl%>">退出</a>
    <%}else{%>
      接口错误，请刷新重试
    <%}%>
   </script>
</header>

<div class="navbar" id="userMenu">
</div>
<script type="text/template" id="userMenuTemplate">
<div class="navbar-inner">
<ul class="nav">
  <%var version='1.72'%>
  <%for(var i = 0 ,len = permissions.length;i < len;i++){%>
    <%// MainArea 区首页 ,MainGM 副总首页%>
    <%if(permissions[i] == "MainStore" || permissions[i] == "MainArea" || permissions[i] == "MainGM"){%>
      <li class="pageIndex"><a href="./index.html?random=">首页</a></li>
    <%}else if(permissions[i] == "BusinessManagerStore"){%>
        <li class="pageYyStatus"><a href="./mendianStatus.html?random=<%=version%>">营业状况</a></li>
    <%}else if(permissions[i] == "MentorRelationManager"){%>
      <li class="pagePersonMan"><a href="./manager.html?random=<%=version%>">师徒关系</a></li>
    <%}else if(permissions[i] == "AccountantManager"){%>
      <li class="importPage"><a href="./import.html?random=<%=version%>">录入成本</a></li>
    <%}else if(permissions[i] == "BusinessManagerArea"){%>
        <%// 区营业状况管理%>
         <li class="pageYyStatus"><a href="./areaStatus.html?random=<%=version%>">营业状况</a></li>
    <%}else if(permissions[i] == "BusinessManagerGM"){%>
        <%// 副总营业状况管理%>
        <li class="pageYyStatus"><a href="./fuzongStatus.html?random=<%=version%>">营业状况</a></li>
    <%}else if(permissions[i] == "DianMianTong"){%>
        <li class="pageShops"><a href="http://172.16.4.120/homeStore/login.jsp" target="_blank">店面通</a></li>
    <%}%>
  <%}%>
  
</ul>
 </div>
</script>  
  <p>请按照规定格式上传<span id="showCompany"></span>分公司的成本表格，仅支持Excel 2007版本。</p>
  <p class="dow-example">下载表格样例:<a href="../download/importstorecost.xlsx" download="店面成本表.xlsx">店面成本表</a><a href="../download/importcostperson.xlsx" download="经纪人详情表.xlsx">经纪人详情表</a></p>
  <form action="./" target="submitIframe" enctype="multipart/form-data" method="post"  id="uploadFileForm" class="form-inline sms-search" >
    <input type="hidden" name="userid" id="userId" value="">
    <input type="hidden" name="storeCode" id="storeCode" value="">

    选择时间
    <select class="input-small year" id="year"></select>
    <select class="input-mini month" id="month"></select>
    <input type="hidden" name="yearMonth" id="yearMonth" value="">

    <a href="javascript:;" class="actCurrentMonth">本月</a>
    <label>选择表格:
      <select name="fileType" class=""><option value="2">店面成本表</option><option value="1">经纪人详情表</option></select></label>

    <div style="position:relative">
      <div class="upload-area upload-area-min">
        <input type="file" name="file" id="searchFile">
        <span class="up-info">点击<span class="support">或将文件拖入此区域</span>上传文件</span>
     </div>
     <div class="msglist">

     </div>
    </div>
    <p style="border:1px solid red;display:inline-block;">表格最下面如果填写过内容后delete掉了，请将这些行也删掉，有这类空行的表格无法上传。<br>
    每个店面的成本数据项中，不能有空格或者“-”，没有金额就填写0。
  </p>
     <div class="file-list">
      <ul>   
      </ul>
    </div>
   <input class="btn" type="button" id="subitForm" disabled value="确认提交">
 </form>

</div>


<script type="text/javascript">
var pageConfig = {
  page:"importPage"
};
</script>
<footer class="footer">
	<p>北京链家房地产经纪有限公司</p>
	<p>Copyright©2014 All rights Reserved</p>
</footer>

<script type="text/javascript">

require.config({
	baseUrl: "../asset/js",
	paths: {
		'echarts' : '../../dep/echarts/echarts-all',
		'echarts/chart/bar' : '../../dep/echarts/echarts-all',
		'echarts/chart/line' : '../../dep/echarts/echarts-all',
		'echarts/chart/pie' : '../../dep/echarts/echarts-all',
		'zrender':'../../dep/echarts/echarts-all',
		'common': 'common/common'
	},
	urlArgs:  'v=?1.72'
});
// 基础服务
require(["sms/smscommon"],function(common){
	
})
</script> 
<script type="text/javascript">
// 
$(document).ready(function(){
  if($.config){
    pageInit();
  }else{
    $.listener.on("commmReady",function(){
      pageInit();
    });
  }
  function pageInit(){
    var uploadFileForm = $("#uploadFileForm");
    uploadFileForm.attr("action",$.config.api.importFile)

    function updateYearMonth(e){
      var val = $("#year").val()+$("#month").val();
      $("#yearMonth").val(val);
    }

    $("#year").on("select",updateYearMonth)
    $("#month").on("select",updateYearMonth);

    function setShowUserInfo(data){
      $("#showCompany").html(data.compName);
    }

    var userModel = require("sms/userModel");
    var data = userModel.toJSON();
    if(data.code == "1"){
      setShowUserInfo(data.dataList[0])
    }else{
      userModel.on("change",function(data){
        setShowUserInfo(userModel.toJSON().dataList[0])
      })
    }

    $("#uploadFileForm").attr("action",$.config.api.importFile);
  }

  if(window.FormData){
    $(".upload-area").removeClass("upload-area-min");
  }
  var searchFile = $("#searchFile");
  if(searchFile.length){
    searchFile.on("change",function(e){
      $(".file-list li").remove();
      var val = searchFile.val();
      var point = val.lastIndexOf(".");
      var suffix = val.substring(point);
      if(suffix.toLowerCase() != ".xlsx"){
        alert("请按照规定格式上传");
        return false;
      }
      if(window.FormData){
        var val = searchFile.get(0).files[0];
        if(val){
          $(".file-list ul").append($('<li><a class="close remove" href="#">&times;</a>'+val.name+'</li>'));
        }else{
        }
      }
      if(searchFile.val()){
        submitButton.removeAttr("disabled")
      }else{
        submitButton.attr("disabled","disabled")
      }
    })
  }
 
  $(".file-list").delegate(".remove","click",function(){
    $(this).closest("li").remove();
    return false;
  })
  var submitButton = $("#subitForm"),
      uploadFileForm = $("#uploadFileForm");

  function uploadMyFiles(){

  }

  function loopEnd(json){
    clearTimeout(__loopTimeout);

    submitButton.removeAttr("disabled");
    submitButton.val("确认提交");

    var frame = document.getElementById("submitIframe");
    $(frame).remove();

    if(json.code == '1'){
      
      // $(".file-list li").remove();
      $(".msglist").hide();
      alert("上传成功");
    }else{
      $(".msglist").html(json.msg ? json.msg.replace(/\\n/g,"<br/>"):"no message<br>请检查文件格式");
      $(".msglist").show();
      // alert("上传失败");
    }
  };

  var __loopTimeout = false;
  function startLoop(){
    var frame = document.getElementById("submitIframe");
    try{
      var win = frame.window || frame.contentWindow;
      var body = win.document.body.innerText || win.document.body.textContent;
      var json = JSON.parse(body);
      if(json){
        loopEnd(json);
        clearTimeout(__loopTimeout);
        return;
      }
    }catch(e){

    }
    __loopTimeout = setTimeout(function(){
      startLoop();
    },100)
  }
  function setFormHTML(){
    var frame = document.getElementById("submitIframe");
    try{
      var win = frame.window || frame.contentWindow;
      var body = win.document.body.innerText || win.document.body.textContent;
      
      try{
        var json = JSON.parse(body);
        loopEnd(json);
        clearTimeout(__loopTimeout);
      }catch(e){
        loopEnd({
          code:-1,
          msg:body
        });
      }
    }catch(e){
      loopEnd({
          code:-1,
          msg:"上传失败"
        });
    }
  }


  submitButton.click(function(){


    $("#uploadFileForm").attr("action",$.config.api.importFile);
    if(submitButton.attr("disabled")){
      return;
    }

    submitButton.attr("disabled","disabled");
    submitButton.val("loading..");

    var frame = document.getElementById("submitIframe");
    if(!frame){
      var frame$ = $('<iframe src="" id="submitIframe" name="submitIframe" style="width:0px;height:0px;border:0px;display:none;"></iframe>');
      frame$.appendTo(document.body);
      frame = frame$.get(0);
    }
    frame.onload = function(){
      setFormHTML();
    }
    frame.onerror = function(){
      loopEnd({
        code:-1,
        msg:"上传失败"
      });
    }
    uploadFileForm.submit();

    if(__loopTimeout){
       clearTimeout(__loopTimeout);
    }
    __loopTimeout = setTimeout(function(){
       startLoop();
    },100);
    
  })
})
require(["sms/RevenueView"],function(view){
  var args = {
  }
  var yearMonth = $.formatDate(new Date(),"yyyyMM")
  args.yearMonth = yearMonth; 

  view.init({
    el:"#uploadFileForm",
    args:args
  });

})


</script>
  </body>
</html>