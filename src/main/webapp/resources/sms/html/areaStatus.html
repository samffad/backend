<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>链家网-店面管理系统</title>
<meta charset="utf-8">
<link href="../asset/img/favicon.ico" type="image/x-icon" rel=icon><link href="../asset/img/favicon.ico" type="image/x-icon" rel="shortcut icon">
<link rel="stylesheet" type="text/css" href="../asset/css/common.css?v=1.72"">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="../dep/bootstrap/css/bootstrap.min.css?v=1.72"" rel="stylesheet" media="screen">

<!--[if lt IE 9]>
 <script type="text/javascript" src="../dep/support/html5.js?v=1.72""></script>
 <script src="../dep/support/respond.min.js?v=1.72""></script>
<![endif]-->
<script type="text/javascript" src="../dep/dep.js?v=1.72"></script>
<script src="../asset/js/common/common.js?v=1.72""></script>
  
  <link rel="stylesheet" type="text/css" href="../asset/css/index.css?v=1.72"">
  </head>
  <body>

<div class="max-wrapper">
  <header class="header">
  <div class="logo">
    <p class="sms">SMS<span class="sys-name">链家店面管理系统</span></p>
    <p class="sms-all">Store Management System</p>
  </div>
   <span class="sms-current-user" id="showUserName"></span>
   <script type="text/template" style="display:none" id="showUserNameTemplate">
    <%if(code ==1){%>
      你好，<%=data.userName%>
      <%if(!data.enterSystemDirectly){%>
        <a href="<%=config.changeStore%>">切换店面</a>
      <%}%>
      <a href="<%=config.logoutUrl%>">退出</a>
    <%}else{%>
      接口错误，请刷新重试
    <%}%>
   </script>
</header>

<div class="navbar" id="userMenu">
</div>
<script type="text/template" id="userMenuTemplate">
<div class="navbar-inner">
<ul class="nav">
  <%var version='1.72'%>
  <%for(var i = 0 ,len = permissions.length;i < len;i++){%>
    <%// MainArea 区首页 ,MainGM 副总首页%>
    <%if(permissions[i] == "MainStore" || permissions[i] == "MainArea" || permissions[i] == "MainGM"){%>
      <li class="pageIndex"><a href="./index.html?random=">首页</a></li>
    <%}else if(permissions[i] == "BusinessManagerStore"){%>
        <li class="pageYyStatus"><a href="./mendianStatus.html?random=<%=version%>">营业状况</a></li>
    <%}else if(permissions[i] == "MentorRelationManager"){%>
      <li class="pagePersonMan"><a href="./manager.html?random=<%=version%>">师徒关系</a></li>
    <%}else if(permissions[i] == "AccountantManager"){%>
      <li class="importPage"><a href="./import.html?random=<%=version%>">录入成本</a></li>
    <%}else if(permissions[i] == "BusinessManagerArea"){%>
        <%// 区营业状况管理%>
         <li class="pageYyStatus"><a href="./areaStatus.html?random=<%=version%>">营业状况</a></li>
    <%}else if(permissions[i] == "BusinessManagerGM"){%>
        <%// 副总营业状况管理%>
        <li class="pageYyStatus"><a href="./fuzongStatus.html?random=<%=version%>">营业状况</a></li>
    <%}else if(permissions[i] == "DianMianTong"){%>
        <li class="pageShops"><a href="http://172.16.4.120/homeStore/login.jsp" target="_blank">店面通</a></li>
    <%}%>
  <%}%>
  
</ul>
 </div>
</script>  
  <ul class="nav nav-tabs" id="reportMenu">

</ul>
<script type="text/template" id="reportMenuTemplate">
<%for(var i = 0 ,len = menu.length; i < len;i++){%>
	<li class="<%=menu[i].type%>"><a href="<%=menu[i].url%>"><%=menu[i].title%></a></li>
<%}%>
</script>
<script>
var version = '1.72';
(function(){
	function initReportMenu(){
		var user = window.$currentUser;

		var subUrl = [];
		
		var query = {};//$.queryToJson($.parseURL(location.href).query);
		var pageQuery = $.queryToJson($.parseURL(location.href).query);
		if(pageQuery.time){
			query.time = pageQuery.time;
		}
		
		query.version = version;
		var permissions = user.permissions;
		if(!$.isArray(permissions)){
			permissions = permissions.split(",")
		}

		var perims = "store";
		if($.inArray("BusinessManagerGM",permissions) >=0){
			perims = "gm"
		}else if($.inArray("BusinessManagerArea",permissions) >=0){
			perims = "area"
		}

		// 副总经理 区经理都会有大区
		if(perims == "gm"){
			subUrl.push({
				url:$.joinURL("./fuzongStatus.html",query),
				title:"大区营业状况",
				type:"fuzongPanel"
			})
			if(pageQuery.areaCode){
				query.areaCode = pageQuery.areaCode;
			}
			subUrl.push({
				url:$.joinURL("./areaStatus.html",query),
				title:"门店营业状况",
				type:"areaPanel"
			})
		}else if(perims == "area"){
			subUrl.push({
				url:$.joinURL("./areaStatus.html",query),
				title:"门店营业状况",
				type:"areaPanel"
			})
		}else{
			subUrl.push({
				url:$.joinURL("./mendianStatus.html",query),
				title:"门店营业状况",
				type:"shopPanel"
			})
		}
		
		if(pageQuery.storeCode){
			query.storeCode = pageQuery.storeCode;
		}
		subUrl.push({
			url:$.joinURL("./personstatus.html",query),
			title:"经纪人作业详情",
			type:"personPanel"
		})
		var tpl = _.template($("#reportMenuTemplate").html());
		$("#reportMenu").html(tpl({
			menu:subUrl
		}));
		var curPath = $.parseURL(location.href).path;
		var paths = curPath.split("/");
		var curPage = paths[paths.length-1];

		for(var i = 0 ,len = subUrl.length; i < len;i++){
			if(subUrl[i].url.indexOf(curPage) >=0){
				$("."+subUrl[i].type).addClass("active")
				break;
			}
		}
	}
	

	if(window.$currentUser){
		initReportMenu();
	}else{
		$.listener.on("getUserInfo",function(){
			initReportMenu();
		});
	}
})();
</script> 
  <form id="smsSearchForm" class="form-inline sms-search" onsubmit="return false;">
    选择时间
    <select class="input-small year" id="year"></select>
    <select class="input-mini month" id="month"></select>
    <input type="hidden" name="yearMonth" id="yearMonth" value="">
    <input type="hidden" name="areaCode" id="areaCode" value="">
    <a href="javascript:;" class="actCurrentMonth">本月</a>

    <div class="input-append selectShop" id="storeName">
      <label>选择店面:  
      <div style="position:relative;display:inline;">
      <input type="text" class="span2" name="storeName"  placeholder="全部门店" style="margin-right:0px;"><button class="btn actFocus">
        <i class="icon-th-list"></i>
      </button>

      <input type="hidden" name="storeCode" value="">
      <ul class="dropdown-menu" style="display:none;margin-left:0;">
      </ul>
      </div>
      </label>
    </div>

    <button type="button" class="btn actSearch">查看</button>
    <button type="button" class="btn actExport">导出</button>
  </form>

  <div id="reports">
      <div class="loading">loading...</div>
  </div>
<iframe id="downloadIframe" name="downloadIframe" style="width:0px;height:0px;border:0px;display:none;"></iframe>

<script type="text/template" id="reportsTemplate">
  <%if(typeof total != 'undefined'){%>
  <p>
    <%=$.formatDate(new Date(parseInt(endTime)),"yyyy年M月")%>，<%=areaName%>
    <%for(var i = 0 ; i < total.length;i++){%>
      <%=total[i].name%>为<span class="green"><%=total[i].value%></span>
    <%}%>。
  </p>
  <%}%>
  <%if(typeof list != 'undefined' && list.length >0){%>
  <%for(var i = 0 ,len = list.length; i < len;i++){%>
    <div class="comp" compType="<%=list[i].type%>" id="comp<%=i+1%>">
      <p class="title">
        <%=list[i].name%>
      </p>
      <div class="comp-content" >
        <div style="width:100%;overflow-x: auto;">
        <!--表格-->
        <%if(list[i].type == "table"){%>
          <table class="table table-bordered table-hover ">
            <thead>
            <%=$.parseTH(list[i].label)%>
            </thead>
            <tbody>

            <%for(var j = 0 ; j < list[i].dataList.length;j++){%>
              <tr>
              <%for(var k = 0 ; k < list[i].dataList[j].length;k++){%>
                <%if(k ==4){%>
                    <td class="text-center"><a href="./personstatus.html?time=<%=$("#year").val()%>-<%=$("#month").val()%>&storeCode=<%=list[i].dataList[j][0]%>&v=<%=pageConfig.version%>"><%=list[i].dataList[j][k]%></a></td>
                <%}else{%>
                   <td class="text-center"><%=list[i].dataList[j][k]%></td>
                <%}%>
               
              <%}%>
              </tr>
            <%}%>
            </tbody>
          </table>
          </div>
          <%if(list[i].type == "table" && list[i].totalPage){%>
            <%
            var pageNo = list[i].curPage || 1;
            var totalPages = list[i].totalPage;
            %>
             <div class="pagination pagination-centered">
              <ul>
                  <li class="<%=pageNo==1?'disabled':'actPage'%>" page="<%=pageNo-1%>"><a href="#">&laquo;</a></li>
                <%if(totalPages <= 10){%>
                    <%for(var j = 1; j <= totalPages;j++){%>
                      <li class="<%=pageNo==j?'active disabled':' actPage'%>" page="<%=j%>"><a href="#"><%=j%></a></li>
                    <%}%>
                <%}else{%>
                    <li class="<%=pageNo==1?'active disabled':' actPage'%>" page="1"><a href="#">1</a></li>
                    <%if(pageNo > 8){%>
                         <li class="disabled"><a href="javascript:;">…</a></li>
                    <%}%>
                    <%var startPage = Math.max(pageNo-5,2),endPage = Math.min(pageNo+5,totalPages-1);%>
                    <%for(var j = startPage;j<= endPage;j++){%>
                        <li class="<%=pageNo==j?'active disabled':' actPage'%>" page="<%=j%>"><a href="#"><%=j%></a></li>
                    <%}%>
                    <%if(pageNo < totalPages-3){%>
                        <li class="disabled"><a href="javascript:;">…</a></li>
                    <%}%>
                    <li class="<%=pageNo==totalPages?'active disabled':' actPage'%>" page="<%=totalPages%>"><a href="#"><%=totalPages%></a></li>
                <%}%>
                <li class="<%=pageNo==totalPages?'disabled':'actPage'%>" page="<%=parseInt(pageNo)+1%>"><a href="#">»</a></li>
              </ul>
            </div>
          <%}%>
          
        <%}else if(list[i].type == "bar"){%>
            <div class="chart chart-dom"></div>
        <%}if(list[i].type == "pie"){%>
            <div class="chart chart-dom"></div>
        <%}%>
      </div>
      
    </div>
  <%}%>
  <%}else{%>
    接口请求数据为空
  <%}%>
</script>
  <div class="pre" style="margin-bottom:60px;">
<h4>温馨提示：</h4>
<h5>整体情况</h5>
<p>1、当前负债：当选择日期为本月的时候显示此项，数据截至到上月末，用来标识该店是否有历史负债。如有，数字为亏损金额。</p>

<h5>运营人工成本</h5>
<p>1、底薪：平台对低级别新入职员工支付的基本薪资；</p>
<p>2、保障薪资预计坏账：对于A1以上级别的员工，为保证正常生活所需，公司提供了无息借款形式的保障薪资。考虑资金收回的风险，按照业绩的1%计提；</p>
<p>3、清算调节：上季度的清算结果，在下一季度第一个月的利润中进行体现。比如5月初结算4月的利润时，会将一季度保障薪资坏账的清算结果一起加减计算。</p>
<p>4、提佣：该商圈所有经纪人的提佣金额；</p>
<p>5、保险及公积金：按照规定平台需承担的运营员工的社保费用；</p>
<p>6、人才培养：师徒关系中师傅的收入，成本计入徒弟所属门店。计算方式为本店每个徒弟为师傅贡献的收入，负数清零（但会累计），正数相加，且结合了上月累计的结果。例如1月徒弟贡献-10000元，人才培养成本是0，2月徒弟贡献+40000元 人才培养成本会减去10000，只算30000。 负数清零但会进行累计，只有当正的时候，才会计入成本。</p>
<p>7、工会&外包&残保&互助金：对员工各类关怀性支出；</p>
<p>8、商圈经理保障薪资：如果商圈经理当月分成不足8000，当月应发工资按照8000计算，差额次月计入门店成本。</p>

<h5>助理人工成本</h5>
<p>1、指的是该商圈门店助理的相关费用。若存在一个助理服务多个店面的情况，费用多店平分；</p>

<h5>店面成本</h5>
<p>1、租金：房租按照与业主签订的租赁合同期限和金额，平均摊销到各月（违约金根据当月发生额计入当月门店成本）；</p>
<p>2、装修：主体装修按照门店装修总金额分成36个月，摊销计入每月门店成本。内饰按照门店当月实际发生金额计入当月门店成本。</p>
<p>3、办公费：包含办公设备配置、店面证照费用等日常杂费。物品采购明细可以在采购人（商圈经理或助理）的采购平台上看到；</p>
<p>4、物业/保洁/供暖/维修：按照实际发生费用。</p>

<h5>交易成本</h5>
<p>1、POS手续费：用于支付由于交易产生的POS刷卡、银行转账、支付宝等收付款手续费，计算方式为当月全部手续费总金额*（当月本店总业绩/当月公司总业绩）；</p>
<p>2、独家赔偿金：用于支付独家业务违约产生的赔偿金。</p>

<h5>门店风险基金</h5>
<p>1、门店风险基金，按照业绩1%计提，如发生纠纷单用此费用赔偿，不足以支付的时候公司承担多余部分。</p>
</div>
</div>
<script type="text/javascript">
var pageConfig = {
  page:"pageYyStatus",
  version:"1.72"
};

</script>
<footer class="footer">
	<p>北京链家房地产经纪有限公司</p>
	<p>Copyright©2014 All rights Reserved</p>
</footer>

<script type="text/javascript">

require.config({
	baseUrl: "../asset/js",
	paths: {
		'echarts' : '../../dep/echarts/echarts-all',
		'echarts/chart/bar' : '../../dep/echarts/echarts-all',
		'echarts/chart/line' : '../../dep/echarts/echarts-all',
		'echarts/chart/pie' : '../../dep/echarts/echarts-all',
		'zrender':'../../dep/echarts/echarts-all',
		'common': 'common/common'
	},
	urlArgs:  'v=?1.72'
});
// 基础服务
require(["sms/smscommon"],function(common){
	
})
</script> 
<script type="text/javascript">

var getCurParam = (function(){
  var url = $.parseURL(location.href);
  return $.queryToJson(url.query);
})();

if($.config){
  pageInit();
}else{
  $.listener.on("commmReady",function(){
    pageInit();
  });
}


function pageInit(){
  var config = $.config;
  var searchData = getCurParam.time;
  var searchTime = searchData;
  // 导出
  $(".actExport").attr("url",config.api.daquReportDataDown)

  var args = {
    viewType:"table,pie,bar"
  };
  var initArgs = {};
  if(searchData){
    searchData = searchData.split("-");
    args.yearMonth = parseInt(searchData[0])+""+(searchData[1]);
    initArgs.year = searchData[0];
    initArgs.month = searchData[1];
  }else{
    var yearMonth = $.formatDate(new Date(),"yyyyMM")
    args.yearMonth = yearMonth;
  }
  if(getCurParam.areaCode){
    args.areaCode = getCurParam.areaCode;
    initArgs.areaCode = getCurParam.areaCode;
    $("#areaCode").val(args.areaCode)
  }
  args.curPage = 1;
  args.perPage = 20;

  (function(){
    if(!searchData){
      return;
    }
    var as = $(".nav-tabs a");
    as.each(function(){
      var a = $(this);
      a.attr("href",a.attr("href")+"&time="+searchTime)
    })
  })();

  function parseDateModel(obj){
    var label = JSON.parse(obj.label.replace(/\'/g,"\""));
    obj.label = label;

    for(var i = 0 ; i < obj.dataList.length;i++){
      obj.dataList[i] = obj.dataList[i][0].split(",");
    }
    
    if(obj.type == "bar"){
      var total = parseFloat(obj.total[0]);
      if(total){
        // for(var i = 0 ; i < obj.dataList.length;i++){
        //   for(var j = 0 ; j < obj.dataList[i].length;j++){
        //     obj.dataList[i][j] = Math.floor(obj.dataList[i][j]/total * 100);
        //   }
        // }
      }
      obj.total = total;
      obj.name = "占总业绩比"
      obj.showPercent = true;
    }
    // console.log(obj);
    return obj;
  }

  var reqModel = new $.BaseModel(false,{
    url:config.api.daquReportData,
    args:args,
    parse:function(data){

      if(data.code == 1){
         var result = {
           code:data.code
         }
         var realData = data.dataList[0];
         result.data = {
          total:[],
          list:[]
         }
         // total
         var total = realData.total;
         for(var i = 0 ,len = total.length; i <len;i++ ){
            result.data.total.push(JSON.parse(total[i].replace(/\'/g,"\"")))
         }
         result.data.areaName = realData.areaName;
         result.data.endTime = realData.endTime;

         for(var i = 0 ,len = realData.list.length; i < len;i++){
             // 
          try{
            result.data.list.push(parseDateModel(realData.list[i]));
          }catch(e){
            console && console.error(e)
          }
          
         }
        return result;
      }else{
        return data;
      }
    }
  });

  var reportView = new $.ReportView({
    model:reqModel,
    el:"#reports"
  })

  reportView.init();

  require(["sms/RevenueView"],function(view){
    view.init({
      el:"#smsSearchForm",
      args:initArgs
    });

    view.report.on("argsSet",function(data){
      reportView.setArgs(data);
    })
  })
  require(["sms/suggestView"],function(view){
    var suggestStore = view({
      // 请求查询接口
      url:config.api.storeSearch,
      // 附加参数
      args:args,
      isStatic:true,
      // dom
      el:"#storeName",
      parse:function(data){
        var json = {
          list:[]
        }
        if(data.code == "1"){
          var list = data.dataList;
          json.list.push({
            name:"全部门店",
            value:""
          })
          if(list && list.length ){
            for(var i = 0 ,len = list.length; i < len;i++){
              var str = list[i].split(",");

              json.list.push({
                name:str[0],
                value:str[1]
              })
            }
          }
          return json.list;
        }
        
        return [];
      }
    })
    $("#year,#month").on("change",function(){
      args.yearMonth = $("#year").val()+$("#month").val();
      suggestStore.isStatic = true;
      suggestStore.initSearchData(args);
    })
  })
}



</script>
  </body>
</html>